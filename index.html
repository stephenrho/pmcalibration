<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Calibration Curves for Clinical Prediction Models • pmcalibration</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Calibration Curves for Clinical Prediction Models">
<meta name="description" content="Fit calibrations curves for clinical prediction models and calculate several associated metrics (Eavg, E50, E90, Emax). Ideally predicted probabilities from a prediction model should align with observed probabilities. Calibration curves relate predicted probabilities (or a transformation thereof) to observed outcomes via a flexible non-linear smoothing function. pmcalibration allows users to choose between several smoothers (regression splines, generalized additive models/GAMs, lowess, loess). Both binary and time-to-event outcomes are supported. See Van Calster et al. (2016) &lt;doi:10.1016/j.jclinepi.2015.12.005&gt;; Austin and Steyerberg (2019) &lt;doi:10.1002/sim.8281&gt;; Austin et al. (2020) &lt;doi:10.1002/sim.8570&gt;.">
<meta property="og:description" content="Fit calibrations curves for clinical prediction models and calculate several associated metrics (Eavg, E50, E90, Emax). Ideally predicted probabilities from a prediction model should align with observed probabilities. Calibration curves relate predicted probabilities (or a transformation thereof) to observed outcomes via a flexible non-linear smoothing function. pmcalibration allows users to choose between several smoothers (regression splines, generalized additive models/GAMs, lowess, loess). Both binary and time-to-event outcomes are supported. See Van Calster et al. (2016) &lt;doi:10.1016/j.jclinepi.2015.12.005&gt;; Austin and Steyerberg (2019) &lt;doi:10.1002/sim.8281&gt;; Austin et al. (2020) &lt;doi:10.1002/sim.8570&gt;.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">pmcalibration</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/stephenrho/pmcalibration/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="pmcalibration-calibration-curves-for-clinical-prediction-models">pmcalibration: Calibration Curves for Clinical Prediction Models<a class="anchor" aria-label="anchor" href="#pmcalibration-calibration-curves-for-clinical-prediction-models"></a>
</h1></div>
<p>A clinical prediction model should produce well <em>calibrated</em> risk predictions, meaning the predicted probabilities should align with observed outcome rates. There are different levels at which calibration can be assessed (see <a href="https://pubmed.ncbi.nlm.nih.gov/26772608/" class="external-link uri">https://pubmed.ncbi.nlm.nih.gov/26772608/</a>); this package focuses on assessing “moderate” calibration via non-linear calibration curves. <code>pmcalibration</code> implements calibration curves for binary and (right censored) time-to-event outcomes and calculates metrics used to assess the correspondence between predicted and observed outcome probabilities (the ‘integrated calibration index’ or <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mi>C</mi><mi>I</mi></mrow><annotation encoding="application/x-tex">ICI</annotation></semantics></math>, aka <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><annotation encoding="application/x-tex">E_{avg}</annotation></semantics></math>, as well as <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mn>50</mn></msub><annotation encoding="application/x-tex">E_{50}</annotation></semantics></math>, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mn>90</mn></msub><annotation encoding="application/x-tex">E_{90}</annotation></semantics></math>, and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><annotation encoding="application/x-tex">E_{max}</annotation></semantics></math> - see below).</p>
<p>A goal of <code>pmcalibration</code> is to implement a range of methods for estimating a smooth relationship between predicted and observed probabilities and to provide confidence intervals for calibration metrics (via bootstrapping or simulation based inference). Users are able to transform predicted risks before creating calibration curve (for example, logit transforming appears to improve performance when using a regression spline - <a href="https://doi.org/10.31219/osf.io/4n86q" class="external-link uri">https://doi.org/10.31219/osf.io/4n86q</a>).</p>
<p>The examples below demonstrate usage of the package.</p>
</div>
<div class="section level1">
<h1 id="binary-outcome">Binary outcome<a class="anchor" aria-label="anchor" href="#binary-outcome"></a>
</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># to install</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"pmcalibration"</span>) <span class="co"># cran</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="co"># or </span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"stephenrho/pmcalibration"</span>) <span class="co"># development</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stephenrho/pmcalibration" class="external-link">pmcalibration</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate some data for vignette</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2345</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sim_dat.html">sim_dat</a></span><span class="op">(</span><span class="fl">1000</span>, a1 <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, a3 <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># show the first 3 columns (col 4 is the true linear predictor/LP)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span><span class="op">-</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;            x1         x2 y</span></span>
<span><span class="co">#&gt; 1 -1.19142464 -0.9245914 0</span></span>
<span><span class="co">#&gt; 2  0.54930055 -1.0019698 0</span></span>
<span><span class="co">#&gt; 3 -0.06240514  1.5438665 1</span></span>
<span><span class="co">#&gt; 4  0.26544150  0.1632147 1</span></span>
<span><span class="co">#&gt; 5 -0.23459751 -1.2009388 0</span></span>
<span><span class="co">#&gt; 6 -0.99727160 -1.1899600 0</span></span></code></pre></div>
<p>We have data with a binary outcome, <code>y</code>, and two ‘predictor’ variables, <code>x1</code> and <code>x2</code>. Suppose we have an existing model for predicting <code>y</code> from <code>x1</code> and <code>x2</code> that is as follows</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">p</span>(<span class="at">y =</span> <span class="dv">1</span>) <span class="ot">=</span> <span class="fu">plogis</span>( <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">*</span>x1 <span class="sc">+</span> <span class="dv">1</span><span class="sc">*</span>x2 )</span></code></pre></div>
<p>To externally validate this model on this new data we need to calculate the predicted probabilities. We’ll also extract the observed outcomes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">dat</span>, <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">$</span><span class="va">y</span></span></code></pre></div>
<p>First we can check weak calibration:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">lcal</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/logistic_cal.html">logistic_cal</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Logistic calibration intercept and slope:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                       Estimate Std. Error z value Pr(&gt;|z|) lower upper</span></span>
<span><span class="co">#&gt; Calibration Intercept    -0.11      0.080   -1.38     0.17 -0.27 0.046</span></span>
<span><span class="co">#&gt; Calibration Slope         1.06      0.078    0.80     0.42  0.91 1.220</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; z-value for calibration slope is relative to slope = 1.</span></span>
<span><span class="co">#&gt; lower and upper are the bounds of 95% profile confidence intervals.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Likelihood ratio tests (a = intercept, b = slope):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                                              statistic df Pr(&gt;Chi)</span></span>
<span><span class="co">#&gt; Weak calibration - H0: a = 0, b = 1               2.57  2     0.28</span></span>
<span><span class="co">#&gt; Calibration in the large - H0: a = 0 | b = 1      1.91  1     0.17</span></span>
<span><span class="co">#&gt; Calibration slope - H0: b = 1 | a                 0.65  1     0.42</span></span></code></pre></div>
<p>The top part of the printed summary gives estimates of the calibration intercept and slope and their 95% CIs. The bottom part of the printed summary gives likelihood ratio tests (see <a href="https://journals.sagepub.com/doi/abs/10.1177/0272989X9301300107" class="external-link">Miller et al. 1993</a>) assessing (1) weak calibration as a whole (the null hypothesis of intercept = 0 and slope = 1), (2) calibration in the large (H0: intercept = 0 given slope = 1), and (3) the calibration slope (H0: slope = 1). This output suggests the model the model is reasonably weakly calibrated: the calibration intercept and slope don’t clearly differ from 0 and 1, respectively.</p>
<p>We can use a calibration curve to assess ‘moderate’ calibration. Below we use <code>pmcalibration</code> to fit a flexible calibration curve, allowing for a non-linear relationship between predicted and actual probabilities.</p>
<p>In the example below, we fit a calibration curve using a restricted cubic spline with 5 knots (see <code><a href="https://rdrr.io/pkg/rms/man/rms.trans.html" class="external-link">?rms::rcs</a></code>). <code>transf="logit"</code> signals that the predicted risks should be logit transformed before fitting the calibration curve (this is the default for a binary <code>y</code>). <code>pmcalibration</code> calculates various metrics from the absolute difference between the predicted probability and the actual probability (as estimated by the calibration curve). In this case 95% confidence intervals for these metrics are calculated via simulation based inference (<code>ci = "sim"</code>) with 1000 replicates. Alternatively we could have chosen bootstrap confidence intervals (<code>ci = "boot"</code>).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">cc</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pmcalibration.html">pmcalibration</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, p <span class="op">=</span> <span class="va">p</span>, </span>
<span>                     smooth <span class="op">=</span> <span class="st">"rcs"</span>, nk <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                     transf<span class="op">=</span><span class="st">"logit"</span>,</span>
<span>                     ci <span class="op">=</span> <span class="st">"sim"</span>, </span>
<span>                     n<span class="op">=</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-4-1.png" width="100%"></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co">#&gt; Calibration metrics based on a calibration curve estimated for a binary outcome via a restricted cubic spline (see ?rms::rcs) using logit transformed predicted probabilities.</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">#&gt;      Estimate lower upper</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co">#&gt; Eavg    0.054 0.035 0.076</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co">#&gt; E50     0.059 0.031 0.079</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="co">#&gt; E90     0.083 0.060 0.134</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="co">#&gt; Emax    0.138 0.081 0.448</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co">#&gt; ECI     0.368 0.177 0.751</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="co">#&gt; 95% confidence intervals calculated via simulation based inference with 1000 replicates.</span></span></code></pre></div>
<p>The printed metrics can be interpreted as follows:</p>
<ul>
<li>
<code>Eavg</code> suggests that the average difference between prediction and actual probability of the outcome is 0.054 (or 5%) with a 95% CI of [0.035, 0.076].</li>
<li>
<code>E50</code> is the median difference between prediction and observed probability (inferred from calibration curve). 50% of differences are 0.059 or smaller.</li>
<li>
<code>E90</code> is the 90th percentile difference. 90% of differences are 0.083 or smaller.</li>
<li>
<code>Emax</code> is the largest observed difference between predicted and observed probability. The model can be off by up to 0.14, with a broad confidence interval.</li>
<li>
<code>ECI</code> is the average squared difference between predicted and observed probabilities (multiplied by 100). See <a href="https://pubmed.ncbi.nlm.nih.gov/25579635/" class="external-link">Van Hoorde et al. (2015)</a>.</li>
</ul>
<p><code>pmcalibration</code> produces a plot by default, as shown above. A more custom plot can be obtained via <code>plot</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cc</span>, xlab<span class="op">=</span><span class="st">"Predicted Risk of Outcome"</span>, ylab<span class="op">=</span><span class="st">"Expected Proportion with Outcome"</span>, fillcol <span class="op">=</span> <span class="st">"blue"</span>, ideallty <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-5-1.png" width="100%"></p>
<p>Or one could use <code>get_curve</code> to extract data for plotting with method of your choice.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcc</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_curve.html">get_curve</a></span><span class="op">(</span><span class="va">cc</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pcc</span><span class="op">)</span> </span>
<span><span class="co">#&gt;             p        p_c      lower     upper</span></span>
<span><span class="co">#&gt; 1 0.005804309 0.14402182 0.03580601 0.4538340</span></span>
<span><span class="co">#&gt; 2 0.015274021 0.11541021 0.04965833 0.2590454</span></span>
<span><span class="co">#&gt; 3 0.024743733 0.10296340 0.05610697 0.1868902</span></span>
<span><span class="co">#&gt; 4 0.034213445 0.09521032 0.05846271 0.1543373</span></span>
<span><span class="co">#&gt; 5 0.043683157 0.08985188 0.05926845 0.1357910</span></span>
<span><span class="co">#&gt; 6 0.053152869 0.08642764 0.05780335 0.1307891</span></span>
<span><span class="co"># p = predicted risk (x-axis; this is not p provided to pmcalibration but is determined by eval)</span></span>
<span><span class="co"># p_c = risk implied by calibration curve (y-axis)</span></span></code></pre></div>
<p>The model in its current form very slightly overestimates risk at low levels of predicted risk and then underestimates risk at predicted probabilities of over around 0.6.</p>
<p>The results above can be compared with <code><a href="https://rdrr.io/pkg/rms/man/val.prob.html" class="external-link">rms::val.prob</a></code>. Note that this uses <code>lowess(p, y, iter=0)</code> to fit a calibration curve. In this case <code>lowess</code> results in the curve extending beyond the possible range of risks, but the Emax, E90, and Eavg point estimates are consistent with those above.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hbiostat.org/R/rms/" class="external-link">rms</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: Hmisc</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'Hmisc'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     format.pval, units</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rms/man/val.prob.html" class="external-link">val.prob</a></span><span class="op">(</span>p <span class="op">=</span> <span class="va">p</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-7-1.png" width="100%"></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co">#&gt;       Dxy   C (ROC)        R2         D  D:Chi-sq       D:p         U  U:Chi-sq </span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co">#&gt;     0.627     0.813     0.348     0.280   281.217     0.000     0.001     2.566 </span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co">#&gt;       U:p         Q     Brier Intercept     Slope      Emax       E90      Eavg </span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co">#&gt;     0.277     0.280     0.148    -0.076     1.062     0.145     0.073     0.044 </span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co">#&gt;       S:z       S:p </span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co">#&gt;    -2.238     0.025</span></span></code></pre></div>
<p>Note also that the calibration intercept reported by <code><a href="https://rdrr.io/pkg/rms/man/val.prob.html" class="external-link">rms::val.prob</a></code> comes from the same logistic regression as that used to estimate the calibration slope. In <code>logistic_cal</code> the calibration intercept is estimated via a <code>glm</code> with logit transformed predicted probabilities included as an offset term (i.e., with slope fixed to 1 - see, e.g., <a href="https://pubmed.ncbi.nlm.nih.gov/26772608/" class="external-link">Van Calster et al., 2016</a>). The calibration slope is estimated via a separate <code>glm</code>. We can confirm this by accessing the corresponding estimates from the <code>logistic_cal</code> object.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># access the model used to get calibration slope</span></span>
<span><span class="co"># and compare to estimates from val.prob</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">lcal</span><span class="op">$</span><span class="va">calibration_slope</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; (Intercept)          LP </span></span>
<span><span class="co">#&gt;      -0.076       1.062</span></span></code></pre></div>
</div>
<div class="section level1">
<h1 id="time-to-event-outcome">Time to event outcome<a class="anchor" aria-label="anchor" href="#time-to-event-outcome"></a>
</h1>
<p>The code below produces a calibration curve, and associated metrics, for a time-to-event outcome. The curve has to be constructed for predictions at a given time point, so an extra argument <code>time</code> should be specified. Here we use a restricted cubic spline with 5 knots to assess predictions at time = 15. In this case we use <code>ci="boot"</code> to get bootstrap confidence intervals for the metrics and curve (<code>ci="sim"</code> is currently unsupported for time-to-event outcomes). By default predicted risks are transformed via the complementary log-log transformation (<code>function(x) log(-log(1 - x))</code>) before estimating the calibration curve.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">simsurv</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate some data</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">$</span><span class="va">x3</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">$</span><span class="va">x1</span><span class="op">*</span><span class="va">X</span><span class="op">$</span><span class="va">x2</span> <span class="co"># interaction</span></span>
<span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">.2</span>, <span class="st">"x2"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">.2</span>, <span class="st">"x3"</span> <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/simsurv/man/simsurv.html" class="external-link">simsurv</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="st">"weibull"</span>, lambdas <span class="op">=</span> <span class="fl">.01</span>, gammas <span class="op">=</span> <span class="fl">1.5</span>, x <span class="op">=</span> <span class="va">X</span>, betas <span class="op">=</span> <span class="va">b</span>, seed <span class="op">=</span> <span class="fl">246</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">eventtime</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 19.60637</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">eventtime</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 16.52855</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">status</span><span class="op">)</span> <span class="co"># no censoring</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">X</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id eventtime status         x1         x2          x3</span></span>
<span><span class="co">#&gt; 1  1 12.749281      1  0.7534077  0.8486379  0.63937033</span></span>
<span><span class="co">#&gt; 2  2 24.840161      1  0.4614734 -2.1876625 -1.00954805</span></span>
<span><span class="co">#&gt; 3  3  9.087482      1 -0.6338945 -1.8948297  1.20112211</span></span>
<span><span class="co">#&gt; 4  4 24.811402      1 -1.0248165  0.6541197 -0.67035271</span></span>
<span><span class="co">#&gt; 5  5 19.072266      1 -0.1673414 -0.4625003  0.07739544</span></span>
<span><span class="co">#&gt; 6  6 13.595427      1  0.2376988  0.6452848  0.15338343</span></span>
<span></span>
<span><span class="co"># split into development and validation</span></span>
<span><span class="va">ddev</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>, <span class="op">]</span></span>
<span><span class="va">dval</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">[</span><span class="fl">1001</span><span class="op">:</span><span class="fl">2000</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># fit a cox model</span></span>
<span><span class="va">cph</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">eventtime</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span>, data <span class="op">=</span> <span class="va">ddev</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># predicted probability of event at time = 15</span></span>
<span><span class="va">p</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">cph</span>, type<span class="op">=</span><span class="st">"expected"</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>eventtime<span class="op">=</span><span class="fl">15</span>, status<span class="op">=</span><span class="fl">1</span>, x1<span class="op">=</span><span class="va">dval</span><span class="op">$</span><span class="va">x1</span>, x2<span class="op">=</span><span class="va">dval</span><span class="op">$</span><span class="va">x2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">dval</span>, <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">eventtime</span>, <span class="va">status</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calibration curve at time = 15</span></span>
<span><span class="op">(</span><span class="va">cc</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pmcalibration.html">pmcalibration</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, p <span class="op">=</span> <span class="va">p</span>, smooth <span class="op">=</span> <span class="st">"rcs"</span>, nk <span class="op">=</span> <span class="fl">5</span>, </span>
<span>                     ci <span class="op">=</span> <span class="st">"boot"</span>, time <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Calibration metrics based on a calibration curve estimated for a time-to-event outcome (time = 15) via a restricted cubic spline (see ?rms::rcs) using complementary log-log transformed predicted probabilities.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      Estimate lower upper</span></span>
<span><span class="co">#&gt; Eavg    0.051 0.028 0.080</span></span>
<span><span class="co">#&gt; E50     0.046 0.020 0.077</span></span>
<span><span class="co">#&gt; E90     0.077 0.052 0.126</span></span>
<span><span class="co">#&gt; Emax    0.245 0.115 0.407</span></span>
<span><span class="co">#&gt; ECI     0.349 0.146 0.813</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 95% confidence intervals calculated via bootstrap resampling with 1000 replicates.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html" class="external-link">mtext</a></span><span class="op">(</span><span class="st">"time = 15"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-9-1.png" width="100%"></p>
<p>Compare to <code><a href="https://rdrr.io/pkg/rms/man/val.surv.html" class="external-link">rms::val.surv</a></code>, which with the arguments specified below uses <code><a href="https://rdrr.io/pkg/polspline/man/hare.html" class="external-link">polspline::hare</a></code> to fit a calibration curve. Note <code>val.surv</code> uses probability of surviving until time = u <em>not</em> probability of event occurring by time = u.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="op">(</span><span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rms/man/val.surv.html" class="external-link">val.surv</a></span><span class="op">(</span>S <span class="op">=</span> <span class="va">y</span>, est.surv <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="va">p</span>, u<span class="op">=</span><span class="fl">15</span>, </span>
<span>                fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Validation of Predicted Survival at Time= 15     n= 1000 , events= 1000 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; hare fit:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; dim A/D   loglik       AIC        penalty </span></span>
<span><span class="co">#&gt;                                 min    max </span></span>
<span><span class="co">#&gt;   1 Add  -3949.05   7905.02  148.71     Inf</span></span>
<span><span class="co">#&gt;   2 Add  -3874.70   7763.22   60.48  148.71</span></span>
<span><span class="co">#&gt;   3 Add  -3844.46   7709.64   32.04   60.48</span></span>
<span><span class="co">#&gt;   4 Del  -3828.44   7684.51    7.10   32.04</span></span>
<span><span class="co">#&gt;   5 Add  -3824.89   7684.32    0.00    7.10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; the present optimal number of dimensions is 5.</span></span>
<span><span class="co">#&gt; penalty(AIC) was 6.91, the default (BIC), would have been 6.91.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   dim1           dim2           beta        SE         Wald</span></span>
<span><span class="co">#&gt; Constant                            -2.6       0.25  -10.69</span></span>
<span><span class="co">#&gt; Time        26                    -0.031      0.005   -6.27</span></span>
<span><span class="co">#&gt; Co-1  linear                       0.063       0.26    0.24</span></span>
<span><span class="co">#&gt; Time       7.2                     -0.15      0.028   -5.42</span></span>
<span><span class="co">#&gt; Co-1     -0.81                      0.92       0.34    2.74</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Function used to transform predictions:</span></span>
<span><span class="co">#&gt; function (x)  log(-log(x))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Mean absolute error in predicted probabilities: 0.0352 </span></span>
<span><span class="co">#&gt; 0.9 Quantile of absolute errors               : 0.0760</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vs</span>, lim<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-10-1.png" width="100%"></p>
<p>We can make a plot that is easier to compare.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_curve.html">get_curve</a></span><span class="op">(</span><span class="va">cc</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span>, <span class="fl">1</span><span class="op">-</span><span class="va">p_c</span>, type<span class="op">=</span><span class="st">"l"</span>, xlim<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, ylim<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, </span>
<span>             xlab<span class="op">=</span><span class="st">"Predicted Probability of Surviving 15"</span>, </span>
<span>             ylab<span class="op">=</span><span class="st">"Actual Probability of Surviving 15"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">$</span><span class="va">p</span>, y <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">[</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty<span class="op">=</span><span class="fl">2</span>, </span>
<span>        col<span class="op">=</span><span class="st">"black"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>, col<span class="op">=</span><span class="st">"red"</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-11-1.png" width="100%"></p>
</div>
<div class="section level1">
<h1 id="internal-validation">Internal validation<a class="anchor" aria-label="anchor" href="#internal-validation"></a>
</h1>
<p><code>pmcalibration</code> can be used to assess apparent calibration in a development sample or to externally validate an existing prediction model. For conducting internal validation (via bootstrap optimism or cross-validation) users are encouraged to look at <a href="https://stephenrho.github.io/pminternal/" class="external-link uri">https://stephenrho.github.io/pminternal/</a>.</p>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=pmcalibration" class="external-link">View on CRAN</a></li>
<li><a href="https://github.com/stephenrho/pmcalibration/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/stephenrho/pmcalibration/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/GPL-3" class="external-link">GPL-3</a></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing pmcalibration</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Stephen Rhodes <br><small class="roles"> Author, maintainer, copyright holder </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Stephen Rhodes.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
